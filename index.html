<!DOCTYPE html>
<html>
<head>
  <title>One-Sided LP DApp - Tea Sepolia</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h2>One-Sided LP DApp (Tea Sepolia)</h2>
  <button onclick="connectWallet()">Connect Wallet</button>
  <div id="wallet"></div>

  <h3>Tambah Likuiditas dengan Token A Saja</h3>
  <input id="amountTokenA" placeholder="Jumlah Token A" />
  <button onclick="zapIntoLP()">Tambahkan Likuiditas</button>

  <script>
    const tokenAAddress = "0xc0798fc3a96979ACfc0C0bBaf0e43F593C08cfEa";
    const tokenBAddress = "0xC19CdD287d3fBDa68FeC72E22e3Ced53a8f63858";
    const routerAddress = "0xeE567Fe1712Faf6149d80dA1E6934E354124CfE3"; // Uniswap V2 Router di Tea Sepolia

    const abiERC20 = [
      "function approve(address spender, uint amount) public returns (bool)",
      "function balanceOf(address owner) view returns (uint)",
      "function decimals() view returns (uint8)"
    ];

    const abiRouter = [
      "function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)",
      "function addLiquidity(address tokenA, address tokenB, uint amountADesired, uint amountBDesired, uint amountAMin, uint amountBMin, address to, uint deadline) external returns (uint amountA, uint amountB, uint liquidity)"
    ];

    let provider, signer, userAddress;

    async function connectWallet() {
      if (window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        document.getElementById("wallet").innerText = "Terhubung: " + userAddress;
      } else {
        alert("Silakan instal MetaMask terlebih dahulu.");
      }
    }

    async function zapIntoLP() {
      const amountInput = document.getElementById("amountTokenA").value;
      const tokenA = new ethers.Contract(tokenAAddress, abiERC20, signer);
      const tokenB = new ethers.Contract(tokenBAddress, abiERC20, signer);
      const router = new ethers.Contract(routerAddress, abiRouter, signer);

      const decimals = await tokenA.decimals();
      const totalAmount = ethers.parseUnits(amountInput, decimals);
      const halfAmount = totalAmount / 2n;

      const deadline = Math.floor(Date.now() / 1000) + 60 * 20;

      // 1. Setujui penggunaan Token A
      await tokenA.approve(routerAddress, totalAmount);
      console.log("Token A disetujui.");

      // 2. Tukar setengah Token A ke Token B
      const path = [tokenAAddress, tokenBAddress];
      const swapTx = await router.swapExactTokensForTokens(
        halfAmount,
        0,
        path,
        userAddress,
        deadline
      );
      await swapTx.wait();
      console.log("Penukaran Token A ke Token B selesai.");

      // 3. Dapatkan saldo terbaru
      const balanceA = await tokenA.balanceOf(userAddress);
      const balanceB = await tokenB.balanceOf(userAddress);

      // 4. Setujui penggunaan Token B
      await tokenB.approve(routerAddress, balanceB);
      console.log("Token B disetujui.");

      // 5. Tambahkan likuiditas
      const addTx = await router.addLiquidity(
        tokenAAddress,
        tokenBAddress,
        balanceA,
        balanceB,
        0,
        0,
        userAddress,
        deadline
      );
      await addTx.wait();
      alert("Likuiditas berhasil ditambahkan!");
    }
  </script>
</body>
</html>